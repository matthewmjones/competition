<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${company.name} + ' Dashboard'">Company Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">Competition App</a>

            <button class="navbar-toggle" 
                    aria-label="Toggle navigation menu" 
                    aria-expanded="false"
                    aria-controls="navbar-menu">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
        </div>

        <div class="navbar-menu" id="navbar-menu">
            <ul class="navbar-nav">
                <li><a href="/">Home</a></li>
                <li><a href="/dashboard">All Companies</a></li>
                <li><a href="/dashboard/company">Select Company</a></li>
                <li><a href="/company_input">Add Company</a></li>
                <li><a href="/price_input">Add Price</a></li>
                <li><a href="/admin">Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="content-wrapper">
        <a href="/dashboard" class="back-link">← Back to All Companies Dashboard</a>

    <div class="company-info">
        <h1 id="company-heading" th:text="${company.name}">Company Name</h1>
        <div class="info-grid">
            <div class="info-item" th:if="${company.email != null and !#strings.isEmpty(company.email)}">
                <div class="info-label">Email</div>
                <div class="info-value" th:text="${company.email}">contact@company.com</div>
            </div>
            <div class="info-item" th:if="${company.phone != null and !#strings.isEmpty(company.phone)}">
                <div class="info-label">Phone</div>
                <div class="info-value" th:text="${company.phone}">555-0000</div>
            </div>
        </div>
    </div>

    <div class="price-input-section">
        <h3 style="margin-top: 0; color: #007cba;">Add New Price</h3>
        <div id="price-alerts"></div>
        <form class="price-input-form" onsubmit="submitPrice(event)">
            <label for="price-input">New Price:</label>
            <input type="number" 
                   id="price-input" 
                   name="price" 
                   min="1.00" 
                   max="20.00" 
                   step="0.01" 
                   placeholder="1.00 - 20.00"
                   required>
            <button type="submit" id="price-submit-btn">Add Price</button>
        </form>
        <p class="price-validation-text" style="margin: 10px 0 0 0; color: #666; font-size: 14px;">
            Price must be between ¤1.00 and ¤20.00. This will automatically update demand and profit calculations for all companies.
        </p>
    </div>

    <div class="charts-row">
        <div class="chart-half">
            <h2 class="chart-title" th:text="${company.name} + ' Price & Demand Trends'">Price & Demand Trends</h2>
            <div style="margin-bottom: 15px; text-align: center;">
                <span style="color: #007cba;">■ Price (¤1.00 - ¤20.00)</span> &nbsp;&nbsp; 
                <span style="color: #d2001c;">■ Demand (calculated)</span>
            </div>
            <div id="price-demand-chart"></div>
        </div>
        
        <div class="chart-half">
            <h2 class="chart-title" th:text="${company.name} + ' Profit Trends'">Profit Trends</h2>
            <div style="margin-bottom: 15px; text-align: center;">
                <span style="color: #28a745;">■ Profit (calculated)</span>
            </div>
            <div id="profit-chart"></div>
        </div>
    </div>

    <script th:inline="javascript">
        let companyData = /*[[${company}]]*/ {};
        let allDemandsData = /*[[${allDemands}]]*/ [];
        
        const eventSource = new EventSource('/api/chart-updates');
        
        eventSource.addEventListener('chart-update', function(event) {
            console.log('Received chart update event');
            refreshCharts();
        });
        
        eventSource.onerror = function(event) {
            console.log('SSE connection error:', event);
        };
        
        function refreshCharts() {
            const companyName = companyData.name;
            fetch(`/api/chart-data/company/${companyName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching company data:', data.error);
                        return;
                    }
                    console.log('Refreshing company charts with new data');
                    companyData = data;
                    allDemandsData = data.allDemands;
                    redrawAllCharts();
                })
                .catch(error => {
                    console.error('Error fetching chart data:', error);
                });
        }
        
        function showAlert(message, type) {
            const alertsDiv = document.getElementById('price-alerts');
            alertsDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertsDiv.innerHTML = '';
            }, 5000);
        }
        
        function submitPrice(event) {
            event.preventDefault();
            
            const priceInput = document.getElementById('price-input');
            const submitBtn = document.getElementById('price-submit-btn');
            const price = parseFloat(priceInput.value);
            
            if (price < 1.00 || price > 20.00) {
                showAlert('Price must be between ¤1.00 and ¤20.00', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding Price...';
            
            const formData = new FormData();
            formData.append('companyId', companyData.id);
            formData.append('price', price.toFixed(2));
            
            fetch('/price_input', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    priceInput.value = '';
                } else {
                    return response.text().then(text => {
                        throw new Error(`Server error: ${response.status}`);
                    });
                }
            })
            .catch(error => {
                console.error('Error adding price:', error);
                showAlert('Error adding price. Please try again.', 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Price';
            });
        }
        
        function updateHeading() {
            const priceData = companyData.prices ? companyData.prices.map(price => ({
                time: new Date('1970-01-01T' + price.time + 'Z'),
                price: parseFloat(price.price)
            })).sort((a, b) => a.time - b.time) : [];
            
            const companyName = companyData.name || 'Company';
            let headingText = companyName;
            
            if (priceData.length > 0) {
                const currentPrice = priceData[priceData.length - 1].price;
                headingText = `${companyName}: ¤${currentPrice.toFixed(2)}`;
            }
            
            document.getElementById('company-heading').textContent = headingText;
        }

        function redrawAllCharts() {
            d3.select('#price-demand-chart').selectAll('*').remove();
            d3.select('#profit-chart').selectAll('*').remove();
            
            updateHeading();
            
            const priceData = companyData.prices ? companyData.prices.map(price => ({
            time: new Date('1970-01-01T' + price.time + 'Z'),
            price: parseFloat(price.price)
        })).sort((a, b) => a.time - b.time) : [];

        const demandData = companyData.demands ? companyData.demands.map(demand => ({
            time: new Date('1970-01-01T' + demand.time + 'Z'),
            demand: parseFloat(demand.demand)
        })).sort((a, b) => a.time - b.time) : [];

        const profitData = companyData.profits ? companyData.profits.map(profit => ({
            time: new Date('1970-01-01T' + profit.time + 'Z'),
            profit: parseFloat(profit.profit)
        })).sort((a, b) => a.time - b.time) : [];

        if (priceData.length > 0 || demandData.length > 0 || profitData.length > 0) {
            // Responsive margins and dimensions
            const isMobile = window.innerWidth <= 768;
            const margin = isMobile ? 
                {top: 20, right: 50, bottom: 50, left: 60} : // Smaller margins on mobile
                {top: 20, right: 80, bottom: 60, left: 80}; // Full margins on desktop
            
            const container = document.querySelector('.chart-half');
            const containerWidth = container ? container.clientWidth : window.innerWidth;
            
            // More responsive width calculation for mobile
            const availableWidth = isMobile ? 
                Math.min(containerWidth - 20, window.innerWidth - 40) : // Mobile: leave 20px padding
                containerWidth - 40; // Desktop: leave 40px padding
            
            const width = Math.max(250, availableWidth - margin.left - margin.right);
            const height = 350 - margin.top - margin.bottom;
            
            const allTimes = [...priceData.map(d => d.time), ...demandData.map(d => d.time), ...profitData.map(d => d.time)];
            const timeExtent = d3.extent(allTimes);
            
            const globalDemands = allDemandsData.map(d => parseFloat(d.demand));
            const demandExtent = globalDemands.length > 0 ? d3.extent(globalDemands) : [0, 100];
            
            const profitExtent = profitData.length > 0 ? d3.extent(profitData, d => d.profit) : [0, 100];
            
            const xScale = d3.scaleTime()
                .domain(timeExtent)
                .range([0, width]);
                
            const yScalePrice = d3.scaleLinear()
                .domain([1, 20])
                .nice()
                .range([height, 0]);
                
            const yScaleDemand = d3.scaleLinear()
                .domain(demandExtent)
                .nice()
                .range([height, 0]);
                
            const yScaleProfit = d3.scaleLinear()
                .domain(profitExtent)
                .nice()
                .range([height, 0]);
            
            const priceLine = d3.line()
                .x(d => xScale(d.time))
                .y(d => yScalePrice(d.price))
                .curve(d3.curveMonotoneX);
                
            const demandLine = d3.line()
                .x(d => xScale(d.time))
                .y(d => yScaleDemand(d.demand))
                .curve(d3.curveMonotoneX);
                
            const profitLine = d3.line()
                .x(d => xScale(d.time))
                .y(d => yScaleProfit(d.profit))
                .curve(d3.curveMonotoneX);
            
            if (priceData.length > 0 || demandData.length > 0) {
                const svg1 = d3.select('#price-demand-chart').append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom);
                
                const g1 = svg1.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);
            
                g1.append('g')
                    .attr('class', 'grid')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale)
                        .tickSize(-height)
                        .tickFormat('')
                    );
                
                g1.append('g')
                    .attr('class', 'grid')
                    .call(d3.axisLeft(yScalePrice)
                        .tickSize(-width)
                        .tickFormat('')
                    );
            
                g1.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale)
                        .tickFormat(d3.timeFormat('%H:%M'))
                    );
                
                g1.append('g')
                    .attr('class', 'axis axis-price')
                    .call(d3.axisLeft(yScalePrice)
                        .tickFormat(d => '¤' + d.toFixed(2))
                    );
                    
                g1.append('g')
                    .attr('class', 'axis axis-demand')
                    .attr('transform', `translate(${width}, 0)`)
                    .call(d3.axisRight(yScaleDemand)
                        .tickFormat(d => d.toFixed(0))
                    );
            
                g1.append('text')
                    .attr('class', 'axis-label axis-price')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', -50)
                    .attr('x', -height/2)
                    .style('text-anchor', 'middle')
                    .text('Price (¤)');
                    
                g1.append('text')
                    .attr('class', 'axis-label axis-demand')
                    .attr('transform', 'rotate(90)')
                    .attr('y', -width - 50)
                    .attr('x', height/2)
                    .style('text-anchor', 'middle')
                    .text('Demand');
                
                g1.append('text')
                    .attr('transform', `translate(${width / 2}, ${height + margin.bottom - 10})`)
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('fill', '#666')
                    .text('Time');
            
                if (priceData.length > 0) {
                    g1.append('path')
                        .datum(priceData)
                        .attr('class', 'line')
                        .attr('d', priceLine);
                    
                    g1.selectAll('.dot-price')
                        .data(priceData)
                        .enter().append('circle')
                        .attr('class', 'dot')
                        .attr('cx', d => xScale(d.time))
                        .attr('cy', d => yScalePrice(d.price))
                        .attr('r', 5)
                        .append('title')
                        .text(d => `${d3.timeFormat('%H:%M')(d.time)}: ¤${d.price.toFixed(2)}`);
                }
            
                if (demandData.length > 0) {
                    g1.append('path')
                        .datum(demandData)
                        .attr('class', 'line-demand')
                        .attr('d', demandLine);
                    
                    g1.selectAll('.dot-demand')
                        .data(demandData)
                        .enter().append('circle')
                        .attr('class', 'dot-demand')
                        .attr('cx', d => xScale(d.time))
                        .attr('cy', d => yScaleDemand(d.demand))
                        .attr('r', 5)
                        .append('title')
                        .text(d => `${d3.timeFormat('%H:%M')(d.time)}: ${d.demand.toFixed(2)} units`);
                }
            }
            
            if (profitData.length > 0) {
                const svg2 = d3.select('#profit-chart').append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom);
                
                const g2 = svg2.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);
                
                g2.append('g')
                    .attr('class', 'grid')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale)
                        .tickSize(-height)
                        .tickFormat('')
                    );
                
                g2.append('g')
                    .attr('class', 'grid')
                    .call(d3.axisLeft(yScaleProfit)
                        .tickSize(-width)
                        .tickFormat('')
                    );
                
                g2.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale)
                        .tickFormat(d3.timeFormat('%H:%M'))
                    );
                
                g2.append('g')
                    .attr('class', 'axis axis-profit')
                    .call(d3.axisLeft(yScaleProfit)
                        .tickFormat(d => '¤' + d.toFixed(2))
                    );
                
                g2.append('text')
                    .attr('class', 'axis-label axis-profit')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', -50)
                    .attr('x', -height/2)
                    .style('text-anchor', 'middle')
                    .text('Profit (¤)');
                
                g2.append('text')
                    .attr('transform', `translate(${width / 2}, ${height + margin.bottom - 10})`)
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('fill', '#666')
                    .text('Time');
                
                g2.append('path')
                    .datum(profitData)
                    .attr('class', 'line-profit')
                    .attr('d', profitLine);
                
                g2.selectAll('.dot-profit')
                    .data(profitData)
                    .enter().append('circle')
                    .attr('class', 'dot-profit')
                    .attr('cx', d => xScale(d.time))
                    .attr('cy', d => yScaleProfit(d.profit))
                    .attr('r', 5)
                    .append('title')
                    .text(d => `${d3.timeFormat('%H:%M')(d.time)}: ¤${d.profit.toFixed(2)}`);
            }
                
            } else {
                d3.select('#price-demand-chart')
                    .append('div')
                    .attr('class', 'no-data')
                    .html('No price or demand data available for ' + companyData.name + '.<br><a href="/price_input">Add price data</a> to see trends.');
                
                d3.select('#profit-chart')
                    .append('div')
                    .attr('class', 'no-data')
                    .html('No profit data available for ' + companyData.name + '.<br><a href="/price_input">Add price data</a> to see profit trends.');
            }
        }
        
        // Initial chart rendering
        redrawAllCharts();
        
        // Add resize listener for responsive charts
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                redrawAllCharts();
            }, 250); // Debounce resize events
        });
    </script>
    </div>
    
    <script src="/js/responsive-navbar.js"></script>
</body>
</html>